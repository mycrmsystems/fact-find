<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>The Wealth Manager – Client Fact Find</title>
<style>
  /* WealthPro palette */
  :root{
    --blue-dark:#1a365d; --blue:#2563eb;
    --bg:#f9fafb; --card:#ffffff; --text:#111827;
    --muted:#6b7280; --border:#d1d5db;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  header{
    position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:16px;
    padding:12px 16px;color:#fff;background:linear-gradient(135deg,#1a365d 0%,#2563eb 100%);
    box-shadow:0 2px 8px rgba(0,0,0,.08)
  }
  header button{
    background:#fff;color:var(--blue-dark);border:0;border-radius:6px;padding:8px 12px;cursor:pointer;font-weight:600
  }

  .layout{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 64px)}
  aside{
    background:#0f1f38;color:#fff;padding:12px;position:sticky;top:64px;height:calc(100vh - 64px);overflow:auto
  }
  .brand{font-weight:800;margin:6px 0 10px}
  nav{display:flex;flex-direction:column;gap:6px}
  nav button{
    text-align:left;background:#173058;border:0;color:#fff;padding:10px;border-radius:8px;cursor:pointer;font-weight:600
  }
  nav button.active{background:#2563eb}
  main{padding:16px}

  section.card{
    display:none;background:var(--card);border-radius:10px;border:1px solid var(--border);
    padding:18px;margin:0 0 16px 0;box-shadow:0 1px 3px rgba(0,0,0,.04)
  }
  h2{margin:0 0 12px;color:var(--blue-dark)}
  h3{margin:10px 0 6px;color:#173058}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .cols-2-side{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  label{display:block;font-weight:600;margin-top:10px}
  input,select,textarea{width:100%;padding:8px 10px;margin-top:6px;border:1px solid var(--border);border-radius:6px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .muted{color:var(--muted);font-size:.9rem}

  .table{border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-top:10px}
  .table .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;padding:10px;border-top:1px solid var(--border);align-items:center}
  .table .row.head{background:#f3f4f6;font-weight:700;border-top:0}
  .col-1{grid-column:span 1}
  .col-2{grid-column:span 2}
  .col-3{grid-column:span 3}
  .col-4{grid-column:span 4}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  .btn{background:#2563eb;color:#fff;border:0;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:600}
  .btn.add{background:var(--ok)}
  .btn.remove{background:var(--err)}
  .controls{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}

  .group{border:1px dashed var(--border);border-radius:10px;padding:12px;margin:12px 0;background:#f3f4f6}
  .group h4{margin:0 0 10px}
  .totals{display:flex;gap:14px;flex-wrap:wrap;font-weight:700;margin-top:8px}

  .yesno{display:flex;gap:8px;margin:6px 0 14px}
  .yesno button{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  .yesno button.active-yes{background:#ecfdf5;border-color:#34d399}
  .yesno button.active-no{background:#fef2f2;border-color:#f87171}

  @media (max-width:1000px){
    .layout{grid-template-columns:1fr}
    aside{position:static;height:auto}
    .cols-2-side{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="brand">The Wealth Manager – Client Fact Find</div>
  <div>
    <button onclick="window.print()">Print</button>
    <button onclick="saveData()">Save</button>
    <input type="file" id="loadFile" accept="application/json" style="display:none" onchange="loadData(event)"/>
    <button onclick="document.getElementById('loadFile').click()">Load</button>
  </div>
</header>

<div class="layout">
  <aside>
    <nav id="sectionNav"></nav>
  </aside>

  <main>
    <!-- 1. Personal & Partner (side-by-side) -->
    <section class="card" id="personal">
      <h2>Personal & Partner Details</h2>
      <div class="cols-2-side">
        <div>
          <h3>Client 1</h3>
          <label>Full Name<input id="c1_full_name" type="text" oninput="updateClientNames()"></label>
          <label>Date of Birth<input id="c1_dob" type="date"></label>
          <label>Nationality<input id="c1_nat" type="text"></label>
          <label>Email<input id="c1_email" type="email"></label>
          <label>Phone<input id="c1_phone" type="tel"></label>
          <label>Address<textarea id="c1_addr"></textarea></label>
          <label>Employment Status<input id="c1_emp" type="text"></label>
          <label>Occupation<input id="c1_occ" type="text"></label>
        </div>
        <div>
          <h3>Partner</h3>
          <label>Full Name<input id="p_full_name" type="text" oninput="updateClientNames()"></label>
          <label>Date of Birth<input id="p_dob" type="date"></label>
          <label>Nationality<input id="p_nat" type="text"></label>
          <label>Email<input id="p_email" type="email"></label>
          <label>Phone<input id="p_phone" type="tel"></label>
          <label>Address<textarea id="p_address"></textarea></label>
          <label>Employment Status<input id="p_employment" type="text"></label>
          <label>Occupation<input id="p_occupation" type="text"></label>
        </div>
      </div>
    </section>

    <!-- 2. Dependents -->
    <section class="card" id="dependents">
      <h2>Dependents</h2>
      <div class="controls"><button class="btn add" onclick="addDependentRow()">+ Add Dependent</button></div>
      <div class="table" id="dependents_table">
        <div class="row head">
          <div class="col-4">Name</div><div class="col-2">Relationship</div>
          <div class="col-2">DOB</div><div class="col-2">Financially Dependent?</div>
          <div class="col-2">Remove</div>
        </div>
      </div>
    </section>

    <!-- 3. Objectives -->
    <section class="card" id="objectives">
      <h2>Objectives & Priorities</h2>
      <div class="grid-2">
        <label>Short-term (0–3 yrs)<textarea id="obj_short"></textarea></label>
        <label>Medium-term (3–7 yrs)<textarea id="obj_medium"></textarea></label>
        <label>Long-term (7+ yrs)<textarea id="obj_long"></textarea></label>
        <label>Priorities (what matters most & why)<textarea id="obj_priorities"></textarea></label>
      </div>
    </section>

    <!-- 4. Income & Expenditure -->
    <section class="card" id="income">
      <h2>Income & Expenditure</h2>

      <div class="cols-2-side">
        <div>
          <h3>Client 1 Income</h3>
          <label>Gross Annual (£)<input id="c1_gross_annual" type="number" step="0.01" oninput="recalcAll()"></label>
          <label>Net Annual (£)<input id="c1_net_annual" type="number" step="0.01" oninput="syncAnnualMonthly('c1')"></label>
          <label>Net Monthly (£)<input id="c1_net_monthly" type="number" step="0.01" oninput="syncMonthlyAnnual('c1')"></label>
        </div>
        <div>
          <h3>Partner Income</h3>
          <label>Gross Annual (£)<input id="p_gross_annual" type="number" step="0.01" oninput="recalcAll()"></label>
          <label>Net Annual (£)<input id="p_net_annual" type="number" step="0.01" oninput="syncAnnualMonthly('p')"></label>
          <label>Net Monthly (£)<input id="p_net_monthly" type="number" step="0.01" oninput="syncMonthlyAnnual('p')"></label>
        </div>
      </div>

      <!-- Outgoings groups -->
      <div class="group" id="grp-housing">
        <h4>Housing expenses (per month)</h4>
        <div class="grid-4">
          <label>Council tax<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Home insurance<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Electricity<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Gas<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Water<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Licence<input class="out housing" data-group="housing" type="number" step="0.01" placeholder="TV etc."></label>
          <label>Maintenance & repairs<input class="out housing" data-group="housing" type="number" step="0.01"></label>
          <label>Home improvements<input class="out housing" data-group="housing" type="number" step="0.01"></label>
        </div>
        <div class="totals">
          <span>Housing total: £<span id="tot_housing_m">0.00</span>/month ( £<span id="tot_housing_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-transport">
        <h4>Transportation expenses (per month)</h4>
        <div class="grid-4">
          <label>Fuel<input class="out transport" data-group="transport" type="number" step="0.01"></label>
          <label>Public transportation<input class="out transport" data-group="transport" type="number" step="0.01" placeholder="bus/train"></label>
          <label>Motoring insurance<input class="out transport" data-group="transport" type="number" step="0.01"></label>
          <label>Vehicle maintenance & repairs<input class="out transport" data-group="transport" type="number" step="0.01"></label>
          <label>Vehicle tax<input class="out transport" data-group="transport" type="number" step="0.01"></label>
          <label>Parking fees<input class="out transport" data-group="transport" type="number" step="0.01"></label>
        </div>
        <div class="totals">
          <span>Transport total: £<span id="tot_transport_m">0.00</span>/month ( £<span id="tot_transport_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-personal">
        <h4>Personal expenses (per month)</h4>
        <div class="grid-4">
          <label>Accountant<input class="out personal" data-group="personal" type="number" step="0.01"></label>
          <label>Groceries / food<input class="out personal" data-group="personal" type="number" step="0.01"></label>
          <label>Clothing & apparel<input class="out personal" data-group="personal" type="number" step="0.01"></label>
          <label>Health & wellness<input class="out personal" data-group="personal" type="number" step="0.01" placeholder="gym, medical"></label>
          <label>Entertainment<input class="out personal" data-group="personal" type="number" step="0.01" placeholder="dining, hobbies"></label>
          <label>Holidays & travel<input class="out personal" data-group="personal" type="number" step="0.01"></label>
          <label>Education<input class="out personal" data-group="personal" type="number" step="0.01"></label>
          <label>Personal care<input class="out personal" data-group="personal" type="number" step="0.01" placeholder="haircuts, cosmetics"></label>
        </div>
        <div class="totals">
          <span>Personal total: £<span id="tot_personal_m">0.00</span>/month ( £<span id="tot_personal_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-utilities">
        <h4>Utilities (per month)</h4>
        <div class="grid-4">
          <label>Internet<input class="out utilities" data-group="utilities" type="number" step="0.01"></label>
          <label>Mobile phone<input class="out utilities" data-group="utilities" type="number" step="0.01"></label>
          <label>Landline phone<input class="out utilities" data-group="utilities" type="number" step="0.01"></label>
          <label>Cable/streaming<input class="out utilities" data-group="utilities" type="number" step="0.01"></label>
        </div>
        <div class="totals">
          <span>Utilities total: £<span id="tot_utilities_m">0.00</span>/month ( £<span id="tot_utilities_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-family">
        <h4>Family & dependents (per month)</h4>
        <div class="grid-4">
          <label>Childcare / Eldercare<input class="out family" data-group="family" type="number" step="0.01"></label>
          <label>School fees<input class="out family" data-group="family" type="number" step="0.01"></label>
          <label>Child allowances<input class="out family" data-group="family" type="number" step="0.01"></label>
        </div>
        <div class="totals">
          <span>Family total: £<span id="tot_family_m">0.00</span>/month ( £<span id="tot_family_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-health">
        <h4>Health (per month)</h4>
        <div class="grid-4">
          <label>Medical bills<input class="out health" data-group="health" type="number" step="0.01"></label>
          <label>Prescriptions<input class="out health" data-group="health" type="number" step="0.01"></label>
          <label>Dental care<input class="out health" data-group="health" type="number" step="0.01"></label>
          <label>Health insurance<input class="out health" data-group="health" type="number" step="0.01"></label>
        </div>
        <div class="totals">
          <span>Health total: £<span id="tot_health_m">0.00</span>/month ( £<span id="tot_health_y">0.00</span>/year )</span>
        </div>
      </div>

      <div class="group" id="grp-summary">
        <h4>Summary</h4>
        <div class="grid-3">
          <label>Total Net Monthly Income (£)<input id="total_net_monthly" type="number" readonly></label>
          <label>Total Monthly Outgoings (£)<input id="total_outgoings" type="number" readonly></label>
          <label>Net Disposable Income (Monthly) (£)<input id="disposable_monthly" type="number" readonly></label>
        </div>
      </div>
    </section>

    <!-- 5. Assets & Liabilities -->
    <section class="card" id="assets">
      <h2>Assets & Liabilities</h2>
      <h3>Properties</h3>
      <div class="controls"><button class="btn add" onclick="addPropertyRow()">+ Add Property</button></div>
      <div class="table" id="properties_table">
        <div class="row head">
          <div class="col-4">Address</div><div class="col-2">Ownership</div>
          <div class="col-2">Value (£)</div><div class="col-2">Mortgage (£)</div><div class="col-2">Remove</div>
        </div>
      </div>

      <h3 style="margin-top:16px">Debts / Loans</h3>
      <div class="controls"><button class="btn add" onclick="addDebtRow()">+ Add Debt/Loan</button></div>
      <div class="table" id="debts_table">
        <div class="row head">
          <div class="col-4">Lender / Type</div><div class="col-2">Balance (£)</div>
          <div class="col-2">Monthly (£)</div><div class="col-2">Rate (%)</div><div class="col-2">Remove</div>
        </div>
      </div>
    </section>

    <!-- 6. Protection -->
    <section class="card" id="protection">
      <h2>Protection</h2>
      <div class="controls"><button class="btn add" onclick="addPolicyRow()">+ Add Policy</button></div>
      <div class="table" id="policies_table">
        <div class="row head">
          <div class="col-2">Type</div><div class="col-2">Owner</div><div class="col-3">Provider</div>
          <div class="col-2">Sum Assured (£)</div><div class="col-2">Premium / m (£)</div><div class="col-1">Remove</div>
        </div>
      </div>
    </section>

    <!-- 7. Pensions -->
    <section class="card" id="pensions">
      <h2>Pensions</h2>
      <h3>Current Pension</h3>
      <div class="grid-2">
        <label>Owner<select id="cur_pen_owner"><option>Client 1</option><option>Partner</option><option>Joint</option></select></label>
        <label>Provider<input id="cur_pen_provider" type="text"></label>
        <label>Type (DC/DB/SIPP/Workplace)<input id="cur_pen_type" type="text"></label>
        <label>Policy/Plan Number<input id="cur_pen_policy" type="text"></label>
        <label>Current Fund Value (£)<input id="cur_pen_value" type="number" step="0.01"></label>
        <label>Retirement Age (target)<input id="cur_pen_age" type="number"></label>
        <label>Employee Contribution (/m £)<input id="cur_pen_ee" type="number" step="0.01"></label>
        <label>Employer Contribution (/m £)<input id="cur_pen_er" type="number" step="0.01"></label>
        <label>Investment Strategy / Funds<input id="cur_pen_strategy" type="text"></label>
        <label>Charges / AMC (%)<input id="cur_pen_charges" type="number" step="0.01"></label>
        <label>Safeguarded Benefits?<select id="cur_pen_safe"><option>No</option><option>Yes</option></select></label>
        <label>Death Benefits<input id="cur_pen_death" type="text"></label>
        <label class="col-12">Notes<textarea id="cur_pen_notes"></textarea></label>
      </div>

      <hr style="margin:18px 0">

      <h3>Other Pensions</h3>
      <div class="controls"><button class="btn add" onclick="addOtherPensionRow()">+ Add Pension</button></div>
      <div class="table" id="other_pensions_table">
        <div class="row head">
          <div class="col-2">Owner</div>
          <div class="col-2">Provider</div>
          <div class="col-2">Type</div>
          <div class="col-2">Policy No.</div>
          <div class="col-2">Value (£)</div>
          <div class="col-2">Remove</div>
        </div>
      </div>

      <template id="otherPensionRow">
        <div class="row">
          <div class="col-2">
            <select name="op_owner"><option>Client 1</option><option>Partner</option><option>Joint</option></select>
          </div>
          <div class="col-2"><input name="op_provider" type="text"></div>
          <div class="col-2"><input name="op_type" type="text" placeholder="DC/DB/SIPP"></div>
          <div class="col-2"><input name="op_policy" type="text"></div>
          <div class="col-2"><input name="op_value" type="number" step="0.01"></div>
          <div class="col-2"><button type="button" class="btn remove" onclick="rm(this)">Remove</button></div>

          <div class="col-12" style="margin-top:8px">
            <div class="grid-3">
              <label>Contributions (/m £)<input name="op_contrib" type="number" step="0.01"></label>
              <label>Charges / AMC (%)<input name="op_charges" type="number" step="0.01"></label>
              <label>Retirement Age (target)<input name="op_age" type="number"></label>
            </div>
            <div class="grid-2" style="margin-top:8px">
              <label>Safeguarded Benefits?<select name="op_safe"><option>No</option><option>Yes</option></select></label>
              <label>Investment Strategy / Funds<input name="op_strategy" type="text"></label>
            </div>
            <label class="col-12">Notes<textarea name="op_notes"></textarea></label>
          </div>
        </div>
      </template>
    </section>

    <!-- 8. Investments -->
    <section class="card" id="investments">
      <h2>Investments</h2>
      <div class="controls"><button class="btn add" onclick="addInvestmentRow()">+ Add Investment</button></div>
      <div class="table" id="investments_table">
        <div class="row head">
          <div class="col-3">Account Type</div><div class="col-3">Platform/Provider</div>
          <div class="col-2">Owner</div><div class="col-2">Current Value (£)</div><div class="col-2">Remove</div>
        </div>
      </div>
    </section>

    <!-- 9. Estate Planning -->
    <section class="card" id="estate">
      <h2>Estate Planning</h2>
      <div class="grid-2">
        <label>Valid Will in place?<select id="has_will"><option>No</option><option>Yes</option></select></label>
        <label>Will Date<input id="will_date" type="date"></label>
        <label class="col-12">Executors (names & contact)<textarea id="will_exec"></textarea></label>
        <label>LPA – Property & Finance?<select id="lpa_pf"><option>No</option><option>Yes</option></select></label>
        <label>LPA – Health & Welfare?<select id="lpa_hw"><option>No</option><option>Yes</option></select></label>
        <label class="col-12">Attorney(s) details<textarea id="attorneys"></textarea></label>
        <label class="col-12">Trusts (type, trustees, assets)<textarea id="trusts"></textarea></label>
        <label class="col-12">IHT considerations / gifts<textarea id="iht"></textarea></label>
      </div>
    </section>

    <!-- 10. Attitude to Risk -->
    <section class="card" id="risk">
      <h2>Attitude to Risk</h2>
      <label>Investment Approach
        <select id="risk_approach">
          <option>Very Low – prefer cash, avoid risk</option>
          <option>Low – very stable, limited return</option>
          <option>Moderate – accept some risk for return</option>
          <option>High – comfortable with risk for growth</option>
          <option>Very High – seek higher risk / return</option>
        </select>
      </label>
      <div class="grid-2">
        <label>Time Horizon
          <select id="risk_horizon">
            <option>< 3 years</option><option>3–5 years</option><option>5–10 years</option><option>10+ years</option>
          </select>
        </label>
        <label>Previous Investment Experience
          <select id="risk_exp"><option>None</option><option>Limited</option><option>Good</option><option>Extensive</option></select>
        </label>
      </div>
      <label>Capacity for Loss<textarea id="capacity_loss"></textarea></label>
    </section>

    <!-- 11. Vulnerability (your exact wording) -->
    <section class="card" id="vulnerability">
      <h2>Vulnerability Assessment</h2>
      <p class="muted">This section aims to identify any areas of financial risk or instability, allowing us to develop strategies for safeguarding your financial future against unforeseen challenges.</p>

      <div class="cols-2-side">
        <div>
          <h3><span class="c1-name">Client 1</span></h3>
          <label>Do you have any health or cognitive issues that could affect your ability to make financial decisions? <span class="c1-name">Client 1</span></label>
          <div class="yesno" data-target="vul_c1_q1"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Have you experienced any recent life changes that could have affected your financial situation? <span class="c1-name">Client 1</span></label>
          <div class="yesno" data-target="vul_c1_q2"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Have you ever been financially exploited or taken advantage of? <span class="c1-name">Client 1</span></label>
          <div class="yesno" data-target="vul_c1_q3"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Notes<textarea id="vul_c1_notes"></textarea></label>
        </div>

        <div>
          <h3><span class="p-name">Partner</span></h3>
          <label>Do you have any health or cognitive issues that could affect your ability to make financial decisions? <span class="p-name">Partner</span></label>
          <div class="yesno" data-target="vul_p_q1"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Have you experienced any recent life changes that could have affected your financial situation? <span class="p-name">Partner</span></label>
          <div class="yesno" data-target="vul_p_q2"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Have you ever been financially exploited or taken advantage of? <span class="p-name">Partner</span></label>
          <div class="yesno" data-target="vul_p_q3"><button onclick="yn(this,true)">Yes</button><button onclick="yn(this,false)">No</button></div>

          <label>Notes<textarea id="vul_p_notes"></textarea></label>
        </div>
      </div>
    </section>

    <!-- 12. Adviser Notes -->
    <section class="card" id="notes">
      <h2>Adviser Notes</h2>
      <label>General Notes<textarea id="adv_notes" placeholder="Observations, suitability considerations, follow-ups..."></textarea></label>
    </section>
  </main>
</div>

<script>
  /* Build left menu & single-section view */
  const sections=[...document.querySelectorAll('section.card')];
  const nav=document.getElementById('sectionNav');
  sections.forEach(sec=>{
    const b=document.createElement('button');
    b.textContent=sec.querySelector('h2').textContent;
    b.onclick=()=>showSection(sec.id);
    nav.appendChild(b);
  });
  function showSection(id){
    sections.forEach(s=>s.style.display='none');
    [...nav.children].forEach(btn=>btn.classList.remove('active'));
    const tgt=document.getElementById(id); if(tgt) tgt.style.display='block';
    const idx=sections.findIndex(s=>s.id===id); if(idx>-1) nav.children[idx].classList.add('active');
    window.scrollTo({top:0,behavior:'instant'});
  }
  showSection('personal');

  /* Name injection for vulnerability labels */
  function firstName(full){ const t=(full||'').trim(); return t? t.split(' ')[0] : ''; }
  function updateClientNames(){
    const c1=firstName(document.getElementById('c1_full_name').value)||'Client 1';
    const p =firstName(document.getElementById('p_full_name').value)||'Partner';
    document.querySelectorAll('.c1-name').forEach(el=>el.textContent=c1);
    document.querySelectorAll('.p-name').forEach(el=>el.textContent=p);
  }

  /* Yes/No buttons */
  function yn(btn,yes){
    const wrap=btn.parentElement;
    wrap.dataset.value=yes?'Yes':'No';
    wrap.querySelectorAll('button').forEach(b=>b.classList.remove('active-yes','active-no'));
    btn.classList.add(yes?'active-yes':'active-no');
  }

  /* Helpers */
  const num=v=>{const n=parseFloat(v);return isNaN(n)?0:n};

  /* Income sync + totals */
  function syncAnnualMonthly(prefix){
    const annual=document.getElementById(prefix+'_net_annual');
    const monthly=document.getElementById(prefix+'_net_monthly');
    if(annual && monthly && annual.value!==''){ monthly.value=(num(annual.value)/12).toFixed(2); }
    recalcAll();
  }
  function syncMonthlyAnnual(prefix){
    const annual=document.getElementById(prefix+'_net_annual');
    const monthly=document.getElementById(prefix+'_net_monthly');
    if(annual && monthly && monthly.value!==''){ annual.value=(num(monthly.value)*12).toFixed(2); }
    recalcAll();
  }

  /* Register listeners for all outgoings */
  function addOutListeners(){ document.querySelectorAll('.out').forEach(inp=>inp.addEventListener('input',recalcAll)); }
  addOutListeners();

  function sumGroup(groupClass){
    let s=0; document.querySelectorAll('.out.'+groupClass).forEach(i=>s+=num(i.value)); return s;
  }

  function recalcAll(){
    // Group totals
    const groups=['housing','transport','personal','utilities','family','health'];
    groups.forEach(g=>{
      const m=sumGroup(g);
      const y=m*12;
      document.getElementById('tot_'+g+'_m').textContent=m.toFixed(2);
      document.getElementById('tot_'+g+'_y').textContent=y.toFixed(2);
    });

    // Overall totals & disposable
    const c1m=num(document.getElementById('c1_net_monthly').value);
    const pm =num(document.getElementById('p_net_monthly').value);
    const totalIncome=c1m+pm;
    const totalOut=groups.reduce((acc,g)=>acc+sumGroup(g),0);
    document.getElementById('total_net_monthly').value=totalIncome.toFixed(2);
    document.getElementById('total_outgoings').value=totalOut.toFixed(2);
    document.getElementById('disposable_monthly').value=(totalIncome-totalOut).toFixed(2);
  }

  /* Dynamic tables helpers */
  function mkRow(parent, cols){
    const row=document.createElement('div'); row.className='row';
    cols.forEach(c=>{const col=document.createElement('div'); col.className='col-'+(c.span||2); col.appendChild(c.el); row.appendChild(col);});
    parent.appendChild(row); return row;
  }
  function inputEl(type,name){ const i=document.createElement('input'); i.type=type; i.name=name; return i; }
  function numEl(name){ const i=inputEl('number',name); i.step='0.01'; return i; }
  function selectEl(opts){ const s=document.createElement('select'); opts.forEach(o=>{const op=document.createElement('option'); op.textContent=o; s.appendChild(op);}); return s; }
  function removeBtn(){ const b=document.createElement('button'); b.type='button'; b.className='btn remove'; b.textContent='Remove'; b.onclick=()=>b.closest('.row').remove(); return b; }

  /* Dependents */
  const deps=document.getElementById('dependents_table');
  function addDependentRow(){
    mkRow(deps,[
      {span:4,el:inputEl('text','dep_name')},
      {span:2,el:inputEl('text','dep_rel')},
      {span:2,el:inputEl('date','dep_dob')},
      {span:2,el:selectEl(['Yes','No'])},
      {span:2,el:removeBtn()}
    ]);
  }

  /* Properties */
  const props=document.getElementById('properties_table');
  function addPropertyRow(){
    mkRow(props,[
      {span:4,el:inputEl('text','prop_addr')},
      {span:2,el:inputEl('text','prop_owner')},
      {span:2,el:numEl('prop_val')},
      {span:2,el:numEl('prop_mort')},
      {span:2,el:removeBtn()}
    ]);
  }

  /* Debts */
  const debts=document.getElementById('debts_table');
  function addDebtRow(){
    mkRow(debts,[
      {span:4,el:inputEl('text','debt_lender')},
      {span:2,el:numEl('debt_balance')},
      {span:2,el:numEl('debt_monthly')},
      {span:2,el:numEl('debt_rate')},
      {span:2,el:removeBtn()}
    ]);
  }

  /* Protection */
  const pols=document.getElementById('policies_table');
  function addPolicyRow(){
    mkRow(pols,[
      {span:2,el:selectEl(['Life','Critical Illness','Income Protection','PMI','Death in Service'])},
      {span:2,el:selectEl(['Client 1','Partner','Joint'])},
      {span:3,el:inputEl('text','pol_provider')},
      {span:2,el:numEl('pol_sum')},
      {span:2,el:numEl('pol_prem')},
      {span:1,el:removeBtn()}
    ]);
  }

  /* Other pensions */
  const otherPens=document.getElementById('other_pensions_table');
  function addOtherPensionRow(){
    const tpl=document.getElementById('otherPensionRow');
    otherPens.appendChild(tpl.content.cloneNode(true));
  }

  /* Investments */
  const invs=document.getElementById('investments_table');
  function addInvestmentRow(){
    mkRow(invs,[
      {span:3,el:selectEl(['ISA','GIA','Bond','Offshore Bond','Other'])},
      {span:3,el:inputEl('text','inv_provider')},
      {span:2,el:selectEl(['Client 1','Partner','Joint'])},
      {span:2,el:numEl('inv_value')},
      {span:2,el:removeBtn()}
    ]);
  }

  /* Save / Load */
  function collectForm(){
    const data={};
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      const key=el.id || el.name; if(!key) return;
      if(el.type==='checkbox') data[key]=el.checked; else data[key]=el.value;
    });
    document.querySelectorAll('.yesno').forEach(w=>{ data[w.dataset.target]=w.dataset.value||''; });
    return data;
  }
  function populateForm(data){
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      const key=el.id || el.name; if(!(key in data)) return;
      if(el.type==='checkbox') el.checked=!!data[key]; else el.value=data[key];
    });
    document.querySelectorAll('.yesno').forEach(w=>{
      const v=data[w.dataset.target];
      if(!v) return;
      const btn=v==='Yes'? w.querySelector('button:first-child') : w.querySelector('button:last-child');
      if(btn) yn(btn, v==='Yes');
    });
    updateClientNames(); recalcAll();
  }
  function saveData(){
    const blob=new Blob([JSON.stringify(collectForm(),null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    const ts=new Date().toISOString().slice(0,10).replace(/-/g,''); a.download=`fact-find_${ts}.json`;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function loadData(e){
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=()=>{ try{ populateForm(JSON.parse(r.result)); }catch(_){ alert('Invalid JSON'); } };
    r.readAsText(file);
  }

  /* Seed starter rows & first calculations */
  addDependentRow(); addPropertyRow(); addDebtRow(); addPolicyRow(); addOtherPensionRow(); addInvestmentRow();
  updateClientNames(); recalcAll();
</script>
</body>
</html>
